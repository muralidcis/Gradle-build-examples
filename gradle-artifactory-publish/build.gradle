apply plugin: 'java'
apply plugin: 'maven'
apply plugin: 'distribution'
apply plugin: 'war'

// import jsonslurper..... to get json data
import groovy.json.JsonSlurper
def MODULE_BUILD_RULES_FILE = "publish-artifactory-rules.json"

def inputFile = new File(MODULE_BUILD_RULES_FILE)
Object result = new JsonSlurper().parseText(inputFile.text)

def fileLocation
def moduleName
def fileHolder

def moduleType

// setting up the group ID
group = theGroup

uploadArchives << {
  println 'publishing '+moduleType+' to apache archiva'
  repositories {

    // apache archiva connection  and authentication
    mavenDeployer {
      repository(url: "$archivaUrl") {
        authentication(userName: "$userName", password: "$passWord")
      }
    }

    result.moduleType.each {
      id,data -> moduleName = id

      // Generate the file and type
      fileHolder = file("build/"+moduleName+"."+moduleType)

      // Defining artifact for the above generated file
      artifacts {
        archives(fileHolder) {
          name moduleName
          type moduleType
        }
      }

      // Addition of filter for POM associated and for uploading multiple artifacts
      addFilter(moduleName){artifact, file ->
        artifact.name=moduleName
      }

      pom(moduleName).version = data.version
      pom(moduleName).artifactId = data.artifactId
      pom(moduleName).groupId = data.groupId

      println fileHolder


    }

  }

}


task uploadLibraries << {
  moduleType='jar'
  tasks.uploadArchives.execute()
}

task uploadWars << {
  moduleType='war'
  tasks.uploadArchives.execute()
}
