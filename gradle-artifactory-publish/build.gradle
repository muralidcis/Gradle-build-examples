
apply plugin: 'java'
apply plugin: 'maven'


// import jsonslurper..... to get json data
import groovy.json.JsonSlurper
def MODULE_BUILD_RULES_FILE = "publish-artifactory-rules.json"

def inputFile = new File(MODULE_BUILD_RULES_FILE)
Object result = new JsonSlurper().parseText(inputFile.text)
def fileLocation
def fileName
def fileHolder


repositories {
  maven {
    url "$archivaUrl"
    credentials {
      username = "$userName"
      password = "$passWord"
    }
  }
}


// setting up the group ID
group = theGroup


uploadArchives {
  repositories {

    // apache archiva connection  and authentication
    mavenDeployer {
      repository(url: "$archivaUrl") {
        authentication(userName: "$userName", password: "$passWord")
      }

      //
      // fetch the filename, groupId, artifactId and other information from the json data file
      // Run the each loop to upload multiple jar files
      //

      result.publish.each {

        id,data -> fileName = id
        if(data.groupId !=null && data.artifactId !=null && data.version !=null) {

          group=data.groupId

          fileHolder = file("build/"+fileName+".jar")
          artifacts {
            archives(fileHolder) {
              name fileName
              type 'jar'
            }
          }

          addFilter(fileName) {artifact, file ->
            artifact.name == fileName
          }
          pom(fileName).version = data.version
          pom.artifactId = data.artifactId
          pom.groupId = data.groupId
        }
      }
    }

  }
}
